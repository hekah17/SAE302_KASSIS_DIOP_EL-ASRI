<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Chat Priv√© Aero</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <style>
        body { 
            margin: 0; 
            font-family: 'Trebuchet MS', 'Segoe UI', sans-serif;
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
            background: linear-gradient(to bottom, #cae8ff, #ffffff);
        }

        #sidebar { 
            width: 300px; 
            background: linear-gradient(to bottom, #e3f0ff 0%, #cce5ff 100%); 
            border-right: 1px solid #a0bfe4; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }

        #sidebar-header { 
            padding: 20px; 
            background: linear-gradient(to bottom, #ffffff 0%, #d4e6fc 100%);
            border-bottom: 1px solid #a0bfe4;
            color: #2c4a70;
            text-shadow: 0 1px 0 #fff;
        }

        #sidebar-header strong { font-size: 1.2em; color: #000; }
        #sidebar-header a { color: #555; text-decoration: none; font-size: 0.9em; }
        #sidebar-header a:hover { color: #d00; text-decoration: underline; }

        #add-friend-form { padding: 15px; border-bottom: 1px solid #bcd4f0; background: rgba(255,255,255,0.3); }
        
        #add-friend-form input { 
            width: 65%; 
            padding: 6px; 
            border: 1px solid #8baadd; 
            border-radius: 4px;
            background: #fff;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        
        #add-friend-form button { 
            width: 30%; 
            padding: 6px; 
            background: linear-gradient(to bottom, #fff 0%, #ddd 100%);
            border: 1px solid #999;
            border-radius: 4px;
            cursor: pointer; 
            color: #333;
            font-weight: bold;
        }
        #add-friend-form button:hover { background: linear-gradient(to bottom, #f0f0f0 0%, #ccc 100%); }

        #friends-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        
        .friend-item { 
            padding: 12px 20px; 
            cursor: pointer; 
            border-bottom: 1px solid rgba(255,255,255,0.5); 
            color: #1e395b;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }
        .friend-item:hover { 
            background: linear-gradient(to bottom, #f3f8ff 0%, #dbeeff 100%);
            border-top: 1px solid #fff;
            box-shadow: inset 0 0 5px rgba(255,255,255,0.8);
        }
        .friend-item.active { 
            background: linear-gradient(to bottom, #cceeff 0%, #99d6ff 100%);
            border: 1px solid #559fd6;
            font-weight: bold;
            text-shadow: 0 1px 0 rgba(255,255,255,0.7);
        }
        .friend-item::before {
            content: "üë§";
            margin-right: 10px;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
        }

        #chat-area { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            background-color: #fcfcfc;
            background-image: repeating-linear-gradient(45deg, #fcfcfc 25%, transparent 25%, transparent 75%, #fcfcfc 75%, #fcfcfc), repeating-linear-gradient(45deg, #fcfcfc 25%, #f7f9fc 25%, #f7f9fc 75%, #fcfcfc 75%, #fcfcfc);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
        }

        #chat-header { 
            padding: 15px; 
            background: linear-gradient(to bottom, #f9fcff 0%, #e6f1fb 100%); 
            border-bottom: 1px solid #b6d1ee; 
            font-weight: bold; 
            font-size: 1.2em; 
            height: 40px; 
            display: flex; 
            align-items: center; 
            color: #2c4a70;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        #messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }

        .message-bubble { 
            max-width: 60%; 
            padding: 10px 15px; 
            border-radius: 15px; 
            position: relative; 
            word-wrap: break-word; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            font-size: 0.95em;
            line-height: 1.4;
        }

        .message-info { font-size: 0.75em; margin-bottom: 5px; opacity: 0.8; font-weight: bold; }

        .sent { 
            align-self: flex-end; 
            border-bottom-right-radius: 0;
            color: white;
            text-shadow: 0 -1px 0 rgba(0,0,0,0.2);
            background: linear-gradient(to bottom, #a9db80 0%, #96c56f 50%, #7db555 100%);
            border: 1px solid #6c9e47;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.4), 0 2px 3px rgba(0,0,0,0.1); 
        }

        .received { 
            align-self: flex-start; 
            border-bottom-left-radius: 0; 
            background: linear-gradient(to bottom, #ffffff 0%, #f1f1f1 50%, #e1e1e1 100%);
            border: 1px solid #ccc;
            color: #333;
            box-shadow: inset 0 1px 0 #fff, 0 2px 3px rgba(0,0,0,0.1); 
        }

        #input-area { 
            padding: 15px; 
            background: #eef5fb; 
            display: flex; 
            gap: 10px; 
            border-top: 1px solid #b6d1ee; 
        }

        #myMessage { 
            flex-grow: 1; 
            padding: 10px; 
            border-radius: 20px; 
            border: 1px solid #8baadd; 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            font-family: inherit;
        }
        #myMessage:focus { outline: none; border-color: #4da6ff; box-shadow: 0 0 5px rgba(77, 166, 255, 0.5); }

        #sendBtn { 
            padding: 0 25px; 
            border-radius: 20px; 
            border: 1px solid #005a9e; 
            background: linear-gradient(to bottom, #5bbaff 0%, #0078d7 50%, #005a9e 100%);
            color: white; 
            font-weight: bold;
            cursor: pointer; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.4);
            text-shadow: 0 -1px 0 rgba(0,0,0,0.3);
        }
        #sendBtn:hover { filter: brightness(1.1); }
        #sendBtn:active { transform: translateY(1px); background: #0078d7; }

        .alert { padding: 10px; margin: 10px; border-radius: 5px; text-align: center; border: 1px solid rgba(0,0,0,0.1); font-size: 0.9em; }
        .alert.error { background: #ffebeb; color: #d00; border-color: #ffcccc; }
        .alert.success { background: #eaffea; color: #008000; border-color: #ccffcc; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div id="sidebar-header">
            <img src="https://upload.wikimedia.org/wikipedia/commons/9/93/Default_profile_picture_%28male%29_on_Facebook.jpg" style="width: 30px; height: 30px; border-radius: 5px; vertical-align: middle; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2); margin-right:5px;" alt="Avatar">
            <strong>{{ user.username }}</strong>
            <br><small><a href="{{ url_for('logout') }}">(Se d√©connecter)</a></small>
        </div>

        <div id="add-friend-form">
            <form action="{{ url_for('add_friend') }}" method="POST">
                <input type="text" name="username" placeholder="Pseudo ami..." required>
                <button type="submit" title="Ajouter un contact">+</button>
            </form>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <ul id="friends-list">
            {% for friend in user.friends %}
                <li class="friend-item" data-id="{{ friend.id }}" data-name="{{ friend.username }}">
                    <span style="flex-grow:1;">{{ friend.username }}</span>
                    <span style="font-size:0.7em; color:green;">‚óè En ligne</span>
                </li>
            {% else %}
                <li style="padding: 15px; color: #555; text-align: center; font-style: italic;">
                    Liste de contacts vide.<br>Ajoutez quelqu'un !
                </li>
            {% endfor %}
        </ul>
    </div>

    <div id="chat-area">
        <div id="chat-header">
            <span id="chat-title">S√©lectionnez un contact pour d√©marrer une conversation</span>
        </div>

        <div id="messages">
            <div style="text-align: center; color: #aaa; margin-top: 50px;">
                <h1 style="font-size: 3em; opacity: 0.3;">Chat Aero</h1>
                <p>Messagerie Instantan√©e S√©curis√©e</p>
            </div>
        </div>

        <div id="input-area" style="display: none;"> 
            <input type="text" id="myMessage" placeholder="√âcrivez un message...">
            <button id="sendBtn">Envoyer</button>
        </div>
    </div>

    <script type="text/javascript">
        $(document).ready(function() {
            var socket = io();
            
            var currentRecipientId = null;
            var currentRoomId = null;
            var myUsername = "{{ user.username }}";

            function afficherMessage(sender, msg, timestamp) {
                var cssClass = (sender === myUsername) ? 'sent' : 'received';
                var senderLabel = (sender === myUsername) ? 'Moi' : sender;

                var html = `
                    <div class="message-bubble ${cssClass}">
                        <div class="message-info">${senderLabel} ‚Ä¢ ${timestamp}</div>
                        ${msg}
                    </div>
                `;
                
                // Si c'est le premier message apr√®s le placeholder, on vide le div
                if ($('#messages').find('h1').length > 0) {
                     $('#messages').empty();
                }

                $('#messages').append(html);
                $('#messages').scrollTop($('#messages')[0].scrollHeight);
            }

            $('.friend-item').on('click', function() {
                $('.friend-item').removeClass('active');
                $(this).addClass('active');

                currentRecipientId = $(this).data('id');
                var friendName = $(this).data('name');

                $('#chat-title').html('<span style="color:green; font-size:1.5em; vertical-align:middle;">‚óè</span> Discussion avec ' + friendName);
                $('#input-area').show();
                
                $('#messages').empty();

                $.get('/get_history/' + currentRecipientId, function(history) {
                    if(history.length === 0) {
                        $('#messages').append('<div style="text-align:center; color:#888; margin-top:20px; font-style:italic;">Aucun historique de conversation.</div>');
                    }
                    history.forEach(function(message) {
                        afficherMessage(message.sender, message.msg, message.timestamp);
                    });
                });

                socket.emit('join_private_chat', {'friend_id': currentRecipientId});
            });

            socket.on('room_joined', function(data) {
                currentRoomId = data.room_id;
            });

            socket.on('message_recu', function(data) {
                afficherMessage(data.sender, data.msg, data.timestamp);
            });

            $('#sendBtn').on('click', function() {
                var messageText = $('#myMessage').val();
                
                if (messageText.trim() !== "" && currentRoomId) {
                    socket.emit('private_message', {
                        'message': messageText,
                        'recipient_id': currentRecipientId,
                        'room_id': currentRoomId
                    });
                    
                    $('#myMessage').val('');
                }
            });

            $('#myMessage').keypress(function(e) {
                if(e.which == 13) { $('#sendBtn').click(); }
            });
        });
    </script>
</body>
</html>