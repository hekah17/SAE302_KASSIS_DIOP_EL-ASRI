<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>SAE302 ‚óè {{ user.username }}</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script> <!--√©quivalent des imports-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <style>
        body { 
            margin: 0; 
            font-family: 'Trebuchet MS', 'Segoe UI', sans-serif;
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
            background: linear-gradient(to bottom, #cae8ff, #ffffff);
        }

        #sidebar { 
            width: 300px; 
            background: linear-gradient(to bottom, #e3f0ff 0%, #cce5ff 100%); 
            border-right: 1px solid #a0bfe4; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }

        #sidebar-header { 
            padding: 20px; 
            background: linear-gradient(to bottom, #ffffff 0%, #d4e6fc 100%);
            border-bottom: 1px solid #a0bfe4;
            color: #2c4a70;
            text-shadow: 0 1px 0 #fff;
        }

        #sidebar-header strong { font-size: 1.2em; color: #000; }
        #sidebar-header a { color: #555; text-decoration: none; font-size: 0.9em; }
        #sidebar-header a:hover { color: #d00; text-decoration: underline; }

        #add-friend-form { padding: 15px; border-bottom: 1px solid #bcd4f0; background: rgba(255,255,255,0.3); }
        
        #add-friend-form input { 
            width: 65%; 
            padding: 6px; 
            border: 1px solid #8baadd; 
            border-radius: 4px;
            background: #fff;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        
        #add-friend-form button { 
            width: 30%; 
            padding: 6px; 
            background: linear-gradient(to bottom, #fff 0%, #ddd 100%);
            border: 1px solid #999;
            border-radius: 4px;
            cursor: pointer; 
            color: #333;
            font-weight: bold;
        }
        #add-friend-form button:hover { background: linear-gradient(to bottom, #f0f0f0 0%, #ccc 100%); }

        #friends-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        
        .friend-item { 
            padding: 12px 20px; 
            cursor: pointer; 
            border-bottom: 1px solid rgba(255,255,255,0.5); 
            color: #1e395b;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }
        .friend-item:hover { 
            background: linear-gradient(to bottom, #f3f8ff 0%, #dbeeff 100%);
            border-top: 1px solid #fff;
            box-shadow: inset 0 0 5px rgba(255,255,255,0.8);
        }
        .friend-item.active { 
            background: linear-gradient(to bottom, #cceeff 0%, #99d6ff 100%);
            border: 1px solid #559fd6;
            font-weight: bold;
            text-shadow: 0 1px 0 rgba(255,255,255,0.7);
        }
        .friend-item::before {
            content: "üë§";
            margin-right: 10px;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
        }

        #chat-area { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            background-color: #fcfcfc;
            background-image: repeating-linear-gradient(45deg, #fcfcfc 25%, transparent 25%, transparent 75%, #fcfcfc 75%, #fcfcfc), repeating-linear-gradient(45deg, #fcfcfc 25%, #f7f9fc 25%, #f7f9fc 75%, #fcfcfc 75%, #fcfcfc);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
        }

        #chat-header { 
            padding: 15px; 
            background: linear-gradient(to bottom, #f9fcff 0%, #e6f1fb 100%); 
            border-bottom: 1px solid #b6d1ee; 
            font-weight: bold; 
            font-size: 1.2em; 
            height: 40px; 
            display: flex; 
            align-items: center; 
            color: #2c4a70;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        #messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }

        .message-bubble { 
            max-width: 60%; 
            padding: 10px 15px; 
            border-radius: 15px; 
            position: relative; 
            word-wrap: break-word; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            font-size: 0.95em;
            line-height: 1.4;
        }

        .message-info { font-size: 0.75em; margin-bottom: 5px; opacity: 0.8; font-weight: bold; }

        .sent { 
            align-self: flex-end; 
            border-bottom-right-radius: 0;
            color: white;
            text-shadow: 0 -1px 0 rgba(0,0,0,0.2);
            background: linear-gradient(to bottom, #a9db80 0%, #96c56f 50%, #7db555 100%);
            border: 1px solid #6c9e47;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.4), 0 2px 3px rgba(0,0,0,0.1); 
        }

        .received { 
            align-self: flex-start; 
            border-bottom-left-radius: 0; 
            background: linear-gradient(to bottom, #ffffff 0%, #f1f1f1 50%, #e1e1e1 100%);
            border: 1px solid #ccc;
            color: #333;
            box-shadow: inset 0 1px 0 #fff, 0 2px 3px rgba(0,0,0,0.1); 
        }

        #input-area { 
            padding: 15px; 
            background: #eef5fb; 
            display: flex; 
            gap: 10px; 
            border-top: 1px solid #b6d1ee; 
        }

        #myMessage { 
            flex-grow: 1; 
            padding: 10px; 
            border-radius: 20px; 
            border: 1px solid #8baadd; 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            font-family: inherit;
        }
        #myMessage:focus { outline: none; border-color: #4da6ff; box-shadow: 0 0 5px rgba(77, 166, 255, 0.5); }

        #sendBtn { 
            padding: 0 25px; 
            border-radius: 20px; 
            border: 1px solid #005a9e; 
            background: linear-gradient(to bottom, #5bbaff 0%, #0078d7 50%, #005a9e 100%);
            color: white; 
            font-weight: bold;
            cursor: pointer; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.4);
            text-shadow: 0 -1px 0 rgba(0,0,0,0.3);
        }
        #sendBtn:hover { filter: brightness(1.1); }
        #sendBtn:active { transform: translateY(1px); background: #0078d7; }

        .alert { padding: 10px; margin: 10px; border-radius: 5px; text-align: center; border: 1px solid rgba(0,0,0,0.1); font-size: 0.9em; }
        .alert.error { background: #ffebeb; color: #d00; border-color: #ffcccc; }
        .alert.success { background: #eaffea; color: #008000; border-color: #ccffcc; }
        
        .badge {
            background-color: #ff3b30;
            color: white;
            font-size: 0.75em;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 10px; 
            margin-left: 10px;
            box-shadow: 0 2px 3px rgba(0,0,0,0.2);
            display: none; 
        }

        #groups-list {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%; /* Force la liste √† prendre toute la largeur */
        }

        .group-item { 
            padding: 12px 20px; 
            cursor: pointer; 
            border-bottom: 1px solid rgba(255,255,255,0.5); 
            color: #1e395b;
            display: flex;
            align-items: center;
            transition: all 0.2s;
        }

        .group-item:hover { 
            background: linear-gradient(to bottom, #f3f8ff 0%, #dbeeff 100%);
        }

        .group-item.active { 
            background: linear-gradient(to bottom, #cceeff 0%, #99d6ff 100%);
            border: 1px solid #559fd6;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div id="sidebar"><!--Toute la gauche de l'√©carn-->
        <div id="sidebar-header">
            <img src="{{ url_for('static', filename='chat/default_pp.png') }}" style="width: 30px; height: 30px; border-radius: 5px; vertical-align: middle; border: 1px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.2); margin-right:5px;" alt="Profile Picture">
            <strong>{{ user.username }}</strong><!--Les accolade sont pour flask, avec lesquelles il remplace ce qu'il y a √† l'interieur par le pseudo de l'user connect√© envoy√© par serveur.py-->
            <br><small><a href="{{ url_for('logout') }}">(Se d√©connecter)</a></small><!--lien pour la d√©connection-->
        </div>

        <div id="add-friend-form">
            <form action="{{ url_for('add_friend') }}" method="POST"><!--connecte le formulaire √† la fonction d'ajout d'amis-->
                <input type="text" name="username" placeholder="Pseudo ami..." required>
                <button type="submit" title="Ajouter un contact">+</button>
            </form>
        </div>

        

        <!--l'accolade et le pourcent servent √† faire des boucles-->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert {{ category }}">{{ message }}</div><!--categorie devient doit error ou sucess et sert pour le style-->
                {% endfor %}
            {% endif %}
        {% endwith %}

        <ul id="friends-list">
            {% for friend in user.friends %}
                <li class="friend-item" data-id="{{ friend.id }}" data-name="{{ friend.username }}">
                    <span style="flex-grow:1;">{{ friend.username }}</span>
                    <span class="badge" id="badge-{{ friend.id }}">0</span> <!--badge √† 0 donc invisible-->
                </li>
            {% else %}
                <li style="padding: 15px; color: #555; text-align: center; font-style: italic;">
                    Liste de contacts vide.<br>Ajoutez quelqu'un !
                </li>
            {% endfor %}
        </ul>

        <div id="sidebar-header" style="margin-top:15px; border-top: 1px solid #a0bfe4;">
            <strong>Groupes</strong>
        </div>

        <div id="create-group-area" style="padding: 10px; font-size: 0.8em; background: rgba(255,255,255,0.2);">
            <form action="{{ url_for('create_group') }}" method="POST">
                <input type="text" name="group_name" placeholder="Nom du groupe..." required style="width: 90%; margin-bottom: 5px;">
                <div style="max-height: 100px; overflow-y: auto; background: white; padding: 5px; border-radius: 4px;">
                    <p style="margin: 0 0 5px 0;">Choisir membres (max 49) :</p>
                    {% for friend in user.friends %}
                        <label style="display: block;">
                            <input type="checkbox" name="friends_to_add" value="{{ friend.id }}"> {{ friend.username }}
                        </label>
                    {% endfor %}
                </div>
                <button type="submit" style="margin-top: 5px; width: 100%;">Cr√©er Groupe</button>
            </form>
        </div>

        <ul id="groups-list">
            {% for group in user.groups %}
                <li class="group-item" data-id="{{ group.id }}" data-name="{{ group.name }}">
                    <span style="flex-grow:1;">üë• {{ group.name }}</span>
                    <span class="badge" id="group-badge-{{ group.id }}">0</span>
                </li>
            {% endfor %}
        </ul>

    </div>

    <div id="chat-area"> <!--partie droite de l'√©cran-->
        <div id="chat-header">
            <span id="chat-title">S√©lectionnez un contact pour d√©marrer une conversation</span>
        </div>

        <div id="messages">
            <div style="text-align: center; color: #aaa; margin-top: 50px;">
                <h1 style="font-size: 3em; opacity: 0.3;">Discussion</h1>
                <p>Discutez avec vos amis !</p>
            </div>
        </div>

        <div id="input-area" style="display: none;"> <!--zone cacher tant que le contact n'est aps selectionn√©-->
            <input type="text" id="myMessage" placeholder="√âcrivez un message...">
            <button id="sendBtn">Envoyer</button>
        </div>
    </div>

    <script type="text/javascript">
        $(document).ready(function() {//on attend que toute la page soit charg√©e
            var socket = io();//d√©marrage de la connexion avec le socket
            
            var currentRecipientId = null; //initialisation d'une variable pour le destinataire 
            var currentRoomId = null; //initialisation d'une variable de l'id de la room de discussion priv√©
            var currentGroupId = null; //initialisation d'une variable de l'id de la room de discussion de groupe
            var myUsername = "{{ user.username }}"; //initialisation du pseudo de l'user
            
            function updateBadge(friendId, count, prefix = 'badge-') {
                var badge = $('#' + prefix + friendId);
                if (count > 0) {
                    badge.text(count);
                    badge.show(); 
                } else {
                    badge.text('0');
                    badge.hide(); 
                }
            }

            $.get('/get_unread_counts', function(data) {
                if (data.private) { //pour la data private recus de get_unread_count
                    for (var friendId in data.private) {
                        updateBadge(friendId, data.private[friendId], 'badge-');
                    }
                }
                if (data.groups) { //pour celle des groupes
                    for (var groupId in data.groups) {
                        updateBadge(groupId, data.groups[groupId], 'group-badge-');
                    }
                }
            });

            //fontion d'affichage de la bulle de chat
            function afficherMessage(sender, msg, timestamp) {
                //style de la bulle (couleur et pseudo)
                var cssClass = (sender === myUsername) ? 'sent' : 'received'; //sent = vert, c'est l'user qui l'envoie et received = gris c'est l'user que la recoie
                var senderLabel = (sender === myUsername) ? 'Moi' : sender; //le pseudo afficher sur la bulle 
                
                var html = `
                    <div class="message-bubble ${cssClass}">
                        <div class="message-info">${senderLabel} ‚Ä¢ ${timestamp}</div>
                        ${msg}
                    </div>
                `;//squelette de l'affichage des bulle sans les var
                
                if ($('#messages').find('h1').length > 0) { //localisation du titre (le gros Discussion de la page d'acccueil) sur la zone o√π il y aura le chat
                     $('#messages').empty(); //si oui, on vide cette zone
                }

                $('#messages').append(html);// on ajoute le code html fait plus tot √† la place
                $('#messages').scrollTop($('#messages')[0].scrollHeight); //Scroll au dernier message de la discussion
            }
            
            //lorsqu'on click sur le feed de discussion d'un amis
            $('.friend-item').on('click', function() {
                $('.friend-item, .group-item').removeClass('active'); //on reset le style de tout les items
                $(this).addClass('active'); //on associe le style √† l'item nouvellement cliqu√©
                var clickedId = $(this).data('id');
                updateBadge(clickedId, 0, 'badge-'); //on reupdate le badge pour le passer √† 0

                currentRecipientId = clickedId;
                currentGroupId = null; 
                var friendName = $(this).data('name'); //extraction du nom de l'amis avec lequel on discute

                $('#chat-title').html('Discussion avec ' + friendName); //changement du titre du chat
                $('#input-area').show(); //on change l'√©tat du bouton d'envoie et de la zone d'√©criture √† visible car on √† choisi un contact √† qui parl√©
                
                $('#messages').empty(); //on efface les messages de la conversation pr√©c√©dente

                $.get('/get_history/' + currentRecipientId, function(history) { //le navigateur va chercher les infos sur /get_history sans recharger la page
                    if(history.length === 0) { //si il n'y a pas d'historique
                        $('#messages').append('<div style="text-align:center; color:#888; margin-top:20px; font-style:italic;">Aucun historique de conversation.</div>');
                    }
                    history.forEach(function(message) { //si il y a un historique, pour chaque message
                        afficherMessage(message.sender, message.msg, message.timestamp); //on appelle la fonction des bulles de message
                    });
                });

                socket.emit('join_private_chat', {'friend_id': currentRecipientId}); //envoie un message au serveur pour demander √† join la room de discution
            });

            $(document).on('click', '.group-item', function() { //quand on clique sur le feed d'un group
                $('.friend-item, .group-item').removeClass('active');
                $(this).addClass('active');
                
                currentGroupId = $(this).data('id'); //on prend l'id du group
                currentRecipientId = null; //changement de la varibale d'id pric√© en null

                updateBadge(currentGroupId, 0, 'group-badge-');

                var groupName = $(this).data('name'); //crea de la var de nom du group

                $('#chat-title').html('Groupe : ' + groupName);
                $('#input-area').show();
                $('#messages').empty();

                $.get('/get_group_history/' + currentGroupId, function(history) {
                    if(history.length === 0) {
                        $('#messages').append('<div style="text-align:center; color:#888; margin-top:20px; font-style:italic;">D√©but de la discussion de groupe.</div>');
                    }
                    history.forEach(function(message) {
                        afficherMessage(message.sender, message.msg, message.timestamp);
                    });
                });

                socket.emit('join_group_chat', {'group_id': currentGroupId});
            });

            socket.on('room_joined', function(data) {
                currentRoomId = data.room_id;
            }); //quand la navigateur recois room_joined du serveur, le navigateur note l'id de la room

            socket.on('message_recu', function(data) {
                if (data.group_id) { //si c'est un message de groupe
                    if (data.group_id == currentGroupId) { //si le feed est ouvert on affiche le message instentan√©ment
                        afficherMessage(data.sender, data.msg, data.timestamp);
                    } else if (data.sender !== myUsername){ //si on est pas sur le feed, on update le badge
                        var badge = $('#group-badge-' + data.group_id);
                        var currentCount = parseInt(badge.text()) || 0;
                        updateBadge(data.group_id, currentCount + 1, 'group-badge-');
                    }
                } 
                else { //si c'est un mp
                    if (data.sender_id == currentRecipientId || data.sender === myUsername) {// si le feed est ouvert
                        afficherMessage(data.sender, data.msg, data.timestamp);
                    } else if (data.sender_id && data.sender !== myUsername) 
                        var badge = $('#badge-' + data.sender_id);
                        var currentCount = parseInt(badge.text()) || 0;
                        updateBadge(data.sender_id, currentCount + 1, 'badge-');
                    }
                }
            });

            //quand on appuie sur Envoyer
            $('#sendBtn').on('click', function() {
                var messageText = $('#myMessage').val();
        
                if (messageText.trim() !== "" && currentRoomId) {
                    var payload = {
                        'message': messageText,
                        'room_id': currentRoomId
                    };
                    if (currentGroupId) {
                        payload['group_id'] = currentGroupId;
                    } else {
                        payload['recipient_id'] = currentRecipientId;
                    }
                    socket.emit('send_message', payload);
                    $('#myMessage').val('');
                }
            });

            $('#myMessage').keypress(function(e) {
                if(e.which == 13) { $('#sendBtn').click(); }
            }); //on ecoute tout le clavier et quand la touch entrer (13) est input, on peut envoyer le message
        });

    </script>
</body>
</html>